<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¤¾å€ QR Code æ™ºèƒ½å ±åˆ°ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html5-qrcode/html5-qrcode.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            overscroll-behavior: none;
        }
        #qr-reader {
            border: 2px dashed #a7a7a7;
            border-radius: 1rem;
            overflow: hidden;
            transform: translateZ(0); /*
            -webkit-transform: translateZ(0); */
        }
        .scan-result-card {
            transition: all 0.3s ease-in-out;
            transform: translateY(20px);
            opacity: 0;
            visibility: hidden;
        }
        .scan-result-card.show {
            transform: translateY(0);
            opacity: 1;
            visibility: visible;
        }
    </style>
</head>
<body class="bg-slate-100 flex flex-col items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-2xl mx-auto bg-white rounded-2xl shadow-xl p-6 md:p-8">
        <header class="text-center mb-6">
            <h1 class="text-3xl font-bold text-slate-800">ç¤¾å€æ™ºèƒ½å ±åˆ°ç³»çµ±</h1>
            <p class="text-slate-500 mt-2">è«‹å°‡ä½æˆ¶çš„ QR Code å°æº–æƒææ¡†</p>
        </header>

        <main>
            <!-- æ”å½±æ©Ÿæƒæå€ -->
            <div id="qr-reader" class="w-full aspect-video md:aspect-[4/3] bg-slate-200 flex items-center justify-center">
                <div class="text-slate-500">æ­£åœ¨å•Ÿå‹•æ”å½±æ©Ÿ...</div>
            </div>
            
            <!-- å ±åˆ°æ´»å‹•é¸æ“‡ -->
            <div class="mt-6">
                <label for="event-select" class="block text-sm font-medium text-slate-700">ç›®å‰æ´»å‹•:</label>
                <select id="event-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md shadow-sm">
                    <option>114å¹´å€åˆ†æ‰€æœ‰æ¬Šäººæœƒè­°</option>
                    <option>ä¸­ç§‹è¯æ­¡æ™šæœƒ</option>
                    <option>é˜²ç½ç¤¾å€è¬›ç¿’</option>
                </select>
            </div>
            
            <!-- æƒæçµæœé¡¯ç¤ºå€ -->
            <div id="scan-result-card" class="scan-result-card mt-6 p-5 rounded-lg shadow-md">
                <h3 id="result-title" class="text-xl font-bold text-center"></h3>
                <p id="result-message" class="text-center mt-2"></p>
            </div>

            <!-- æ‰‹å‹•è¼¸å…¥å€ -->
            <div class="mt-6 border-t pt-4">
                 <p class="text-center text-slate-600 mb-2">ç„¡æ³•æƒæï¼Ÿ</p>
                <div class="flex flex-col sm:flex-row gap-2">
                    <input type="text" id="manual-input" placeholder="è«‹è¼¸å…¥æˆ¶è™Ÿï¼Œä¾‹å¦‚: A001" class="flex-grow w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    <button id="manual-submit" class="w-full sm:w-auto bg-indigo-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition">
                        æ‰‹å‹•å ±åˆ°
                    </button>
                </div>
            </div>
        </main>
    </div>

    <footer class="text-center mt-8 text-slate-500 text-sm">
        <p>&copy; 2025 æ™ºèƒ½ç¤¾å€ç®¡ç†ç³»çµ±. All Rights Reserved.</p>
    </footer>

    <script>
        // --- æ¨¡æ“¬å¾Œç«¯è³‡æ–™åº« ---
        const residents = {
            "A001ADDT": { household: "A001", name: "ä½æˆ¶ä¸€" },
            "A002ADDT": { household: "A002", name: "ä½æˆ¶äºŒ" },
            "A003ADDT": { household: "A003", name: "ä½æˆ¶ä¸‰" },
        };
        // ç”¨ä¾†è¨˜éŒ„æ¯å€‹æ´»å‹•çš„å ±åˆ°ç‹€æ³
        let attendance = {};

        // --- DOM å…ƒç´  ---
        const resultCard = document.getElementById('scan-result-card');
        const resultTitle = document.getElementById('result-title');
        const resultMessage = document.getElementById('result-message');
        const manualInput = document.getElementById('manual-input');
        const manualSubmitBtn = document.getElementById('manual-submit');
        const eventSelect = document.getElementById('event-select');

        // --- éŸ³æ•ˆæ¨¡çµ„ ---
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();

        function playSound(type) {
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            gainNode.gain.setValueAtTime(0, audioContext.currentTime);
            gainNode.gain.linearRampToValueAtTime(0.5, audioContext.currentTime + 0.01);

            if (type === 'success') {
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(523.25, audioContext.currentTime); // C5
                setTimeout(() => oscillator.frequency.setValueAtTime(659.25, audioContext.currentTime), 100); // E5
            } else if (type === 'warning') {
                oscillator.type = 'triangle';
                oscillator.frequency.setValueAtTime(440, audioContext.currentTime); // A4
                setTimeout(() => oscillator.frequency.setValueAtTime(349.23, audioContext.currentTime), 100); // F4
            } else { // error
                oscillator.type = 'square';
                oscillator.frequency.setValueAtTime(261.63, audioContext.currentTime); // C4
            }

            oscillator.start(audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.00001, audioContext.currentTime + 0.2);
            oscillator.stop(audioContext.currentTime + 0.2);
        }

        // --- æ ¸å¿ƒå ±åˆ°é‚è¼¯ ---
        function processCheckIn(qrCodeData) {
            const selectedEvent = eventSelect.value;

            // åˆå§‹åŒ–æ´»å‹•å ±åˆ°ç´€éŒ„
            if (!attendance[selectedEvent]) {
                attendance[selectedEvent] = {};
            }

            const resident = residents[qrCodeData];

            if (resident) {
                if (attendance[selectedEvent][qrCodeData]) {
                    // é‡è¤‡å ±åˆ°
                    const checkInTime = attendance[selectedEvent][qrCodeData].time;
                    showResult('warning', 'é‡è¤‡å ±åˆ°', `${resident.household} ${resident.name} å·²æ–¼ ${checkInTime} å ±åˆ°ã€‚`);
                } else {
                    // å ±åˆ°æˆåŠŸ
                    const now = new Date();
                    const timeString = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}`;
                    attendance[selectedEvent][qrCodeData] = { ...resident, time: timeString };
                    showResult('success', 'å ±åˆ°æˆåŠŸï¼', `${resident.household} ${resident.name}ï¼Œæ­¡è¿æ‚¨ï¼`);
                }
            } else {
                // ç„¡æ•ˆ QR Code
                showResult('error', 'ç„¡æ•ˆçš„ QR Code', 'æŸ¥ç„¡æ­¤ä½æˆ¶è³‡æ–™ï¼Œè«‹ç¢ºèª QR Code æ˜¯å¦æ­£ç¢ºã€‚');
            }
        }

        // --- UI æ›´æ–°å‡½å¼ ---
        function showResult(type, title, message) {
            // æ¸…é™¤èˆŠçš„æ¨£å¼
            resultCard.classList.remove('bg-green-100', 'text-green-800', 'bg-yellow-100', 'text-yellow-800', 'bg-red-100', 'text-red-800');

            let bgColor, textColor;
            switch (type) {
                case 'success':
                    bgColor = 'bg-green-100';
                    textColor = 'text-green-800';
                    break;
                case 'warning':
                    bgColor = 'bg-yellow-100';
                    textColor = 'text-yellow-800';
                    break;
                case 'error':
                    bgColor = 'bg-red-100';
                    textColor = 'text-red-800';
                    break;
            }

            resultCard.classList.add(bgColor, textColor, 'show');
            resultTitle.textContent = title;
            resultMessage.textContent = message;

            playSound(type);

            // 5ç§’å¾Œè‡ªå‹•éš±è—
            setTimeout(() => {
                resultCard.classList.remove('show');
            }, 5000);
        }

        // --- æ‰‹å‹•å ±åˆ°è™•ç† ---
        manualSubmitBtn.addEventListener('click', () => {
            const inputHousehold = manualInput.value.trim().toUpperCase();
            if (!inputHousehold) {
                showResult('error', 'è¼¸å…¥éŒ¯èª¤', 'æˆ¶è™Ÿä¸èƒ½ç‚ºç©ºã€‚');
                return;
            }

            const foundQrCode = Object.keys(residents).find(key => residents[key].household === inputHousehold);

            if (foundQrCode) {
                processCheckIn(foundQrCode);
            } else {
                showResult('error', 'æŸ¥ç„¡æ­¤æˆ¶', `æ‰¾ä¸åˆ°æˆ¶è™Ÿç‚º ${inputHousehold} çš„ä½æˆ¶ã€‚`);
            }
            manualInput.value = '';
        });

        // --- QR Code æƒæå™¨è¨­å®š ---
        function onScanSuccess(decodedText, decodedResult) {
            // é¿å…çŸ­æ™‚é–“å…§é‡è¤‡è§¸ç™¼
            if (window.lastScanTime && (Date.now() - window.lastScanTime < 3000)) {
                return;
            }
            window.lastScanTime = Date.now();
            processCheckIn(decodedText);
        }

        function onScanFailure(error) {
            // å¯ä»¥åœ¨æ­¤è™•è™•ç†æƒæå¤±æ•—çš„æ—¥èªŒï¼Œä½†é€šå¸¸ä¸éœ€è¦é¡¯ç¤ºçµ¦ç”¨æˆ¶
        }

        // å°‡æƒæå™¨åˆå§‹åŒ–åŒ…è£æˆä¸€å€‹å‡½å¼
        function initializeScanner() {
            const qrReaderDiv = document.getElementById('qr-reader');
            // æ¸…ç©ºèˆŠè¨Šæ¯
            qrReaderDiv.innerHTML = "<div class='text-slate-500'>æ­£åœ¨å•Ÿå‹•æ”å½±æ©Ÿ...</div>"; 
            
            const html5QrcodeScanner = new Html5Qrcode("qr-reader");

            Html5Qrcode.getCameras().then(devices => {
                if (devices && devices.length) {
                    html5QrcodeScanner.start(
                        { facingMode: "environment" },
                        {
                            fps: 10,
                            qrbox: (viewfinderWidth, viewfinderHeight) => {
                                let minEdge = Math.min(viewfinderWidth, viewfinderHeight);
                                let qrboxSize = Math.floor(minEdge * 0.7);
                                return { width: qrboxSize, height: qrboxSize };
                            }
                        },
                        onScanSuccess,
                        onScanFailure
                    ).catch(err => {
                        console.error("ç„¡æ³•å•Ÿå‹•æƒæå™¨", err);
                        qrReaderDiv.innerHTML = `<div class="flex flex-col items-center justify-center h-full text-red-500 p-4 text-center"><p>ç„¡æ³•å•Ÿå‹•æ”å½±æ©Ÿï¼Œè«‹æª¢æŸ¥ç€è¦½å™¨æ¬Šé™ã€‚</p></div>`;
                    });
                } else {
                     qrReaderDiv.innerHTML = `<div class="flex items-center justify-center h-full text-slate-600 p-4">æ‰¾ä¸åˆ°å¯ç”¨çš„æ”å½±æ©Ÿè£ç½®ã€‚</div>`;
                }
            }).catch(err => {
                console.error("è«‹æ±‚æ”å½±æ©Ÿæ¬Šé™æ™‚ç™¼ç”ŸéŒ¯èª¤", err);
                qrReaderDiv.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-full text-red-600 p-4 text-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-16 h-16 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 10.5l4.72-4.72a.75.75 0 011.28.53v11.38a.75.75 0 01-1.28.53l-4.72-4.72M4.5 18.75h10.5a2.25 2.25 0 002.25-2.25v-9a2.25 2.25 0 00-2.25-2.25H4.5A2.25 2.25 0 002.25 7.5v9a2.25 2.25 0 002.25 2.25z" />
                            <path stroke-linecap="round" stroke-linejoin="round" d="M3 3l18 18" />
                        </svg>
                        <p class="text-xl font-bold mb-2">æ”å½±æ©Ÿæ¬Šé™å·²è¢«å°é–</p>
                        <div class="bg-red-100 p-3 rounded-lg">
                            <p class="text-lg font-semibold text-slate-800">
                                è«‹é»æ“Šç€è¦½å™¨ç¶²å€åˆ—æœ€å·¦é‚Šçš„åœ–ç¤º (ğŸ”’)ï¼Œ<br>ä¸¦å°‡ã€Œæ”å½±æ©Ÿã€æ¬Šé™è¨­å®šç‚ºã€Œ<b>å…è¨±</b>ã€ã€‚
                            </p>
                        </div>
                        <ul class="mt-4 text-sm text-slate-600 list-disc list-inside text-left max-w-sm mx-auto">
                           <li>è«‹ç¢ºèªç¶²å€æ˜¯ä»¥ <b>https://</b> é–‹é ­ã€‚</li>
                           <li>è«‹æª¢æŸ¥æ˜¯å¦æœ‰å…¶ä»–ç¨‹å¼æˆ–æ“´å……åŠŸèƒ½æ­£åœ¨ä½¿ç”¨æ”å½±æ©Ÿã€‚</li>
                        </ul>
                        <button id="retry-camera-btn" class="mt-6 bg-indigo-600 text-white font-semibold py-2 px-6 rounded-md hover:bg-indigo-700 text-lg">
                            è¨­å®šå®Œæˆå¾Œï¼Œé»æ­¤é‡è©¦
                        </button>
                    </div>`;
                document.getElementById('retry-camera-btn').addEventListener('click', initializeScanner);
            });
        }

        document.addEventListener('DOMContentLoaded', (event) => {
            initializeScanner();
        });
    </script>
</body>
</html>
