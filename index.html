<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>社區 QR Code 智能報到系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html5-qrcode/html5-qrcode.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            overscroll-behavior: none;
        }
        #qr-reader {
            border: 2px dashed #a7a7a7;
            border-radius: 1rem;
            overflow: hidden;
            transform: translateZ(0);
        }
        .scan-result-card {
            transition: all 0.3s ease-in-out;
            transform: translateY(20px);
            opacity: 0;
            visibility: hidden;
        }
        .scan-result-card.show {
            transform: translateY(0);
            opacity: 1;
            visibility: visible;
        }
    </style>
</head>
<body class="bg-slate-100 flex flex-col items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-2xl mx-auto bg-white rounded-2xl shadow-xl p-6 md:p-8">
        <header class="text-center mb-6">
            <h1 class="text-3xl font-bold text-slate-800">社區智能報到系統</h1>
            <p class="text-slate-500 mt-2">請將住戶的 QR Code 對準掃描框</p>
        </header>

        <main>
            <!-- 攝影機掃描區 -->
            <div id="qr-reader" class="w-full aspect-video md:aspect-[4/3] bg-slate-200 flex items-center justify-center">
                <div class="text-slate-500">正在啟動攝影機...</div>
            </div>
            
            <!-- 報到活動選擇 -->
            <div class="mt-6">
                <label for="event-select" class="block text-sm font-medium text-slate-700 mb-1">目前活動:</label>
                <div class="flex items-center gap-2">
                    <select id="event-select" class="block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md shadow-sm">
                        <option>114年區分所有權人會議</option>
                        <option>中秋聯歡晚會</option>
                        <option>防災社區講習</option>
                    </select>
                    <button id="add-event-btn" title="新增活動" class="flex-shrink-0 p-2 bg-indigo-100 text-indigo-700 rounded-full hover:bg-indigo-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" />
                        </svg>
                    </button>
                </div>
            </div>
            
            <!-- 掃描結果顯示區 -->
            <div id="scan-result-card" class="scan-result-card mt-6 p-5 rounded-lg shadow-md">
                <h3 id="result-title" class="text-xl font-bold text-center"></h3>
                <p id="result-message" class="text-center mt-2"></p>
            </div>

            <!-- 報到即時資訊 -->
            <div class="mt-6 border-t pt-4">
                <p class="text-center text-slate-600 mb-3 font-semibold">報到即時資訊</p>
                <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 text-center">
                    <div>
                        <p class="text-sm text-slate-500">應到人數</p>
                        <p id="stats-total" class="text-2xl font-bold text-slate-800">0</p>
                    </div>
                    <div>
                        <p class="text-sm text-slate-500">實到人數</p>
                        <p id="stats-attended" class="text-2xl font-bold text-blue-600">0</p>
                    </div>
                    <div>
                        <p class="text-sm text-slate-500">未到人數</p>
                        <p id="stats-absent" class="text-2xl font-bold text-orange-500">0</p>
                    </div>
                    <div>
                        <p class="text-sm text-slate-500">實到區分權</p>
                        <p id="stats-ownership" class="text-2xl font-bold text-green-600">0.00%</p>
                    </div>
                </div>
                <div class="mt-4 flex flex-col sm:flex-row items-center justify-center gap-2 bg-slate-50 p-3 rounded-lg">
                    <label for="quorum-input" class="text-sm font-medium text-slate-700">法定區分權比例(%):</label>
                    <input type="number" id="quorum-input" value="66.67" class="w-24 px-2 py-1 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    <p id="quorum-status" class="text-lg font-bold ml-2"></p>
                </div>
            </div>


            <!-- 手動輸入區 -->
            <div class="mt-6 border-t pt-4">
                 <p class="text-center text-slate-600 mb-2">無法掃描？</p>
                <div class="flex flex-col sm:flex-row gap-2">
                    <input type="text" id="manual-input" placeholder="請輸入戶號，例如: A001" class="flex-grow w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    <button id="manual-submit" class="w-full sm:w-auto bg-indigo-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition">
                        手動報到
                    </button>
                </div>
            </div>

            <!-- 資料管理區 -->
            <div class="mt-6 border-t pt-4">
                <p class="text-center text-slate-600 mb-3 font-semibold">住戶資料管理</p>
                <div class="flex flex-col sm:flex-row gap-2">
                    <button id="import-csv-btn" class="flex-1 bg-blue-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition">匯入 CSV</button>
                    <button id="export-csv-btn" class="flex-1 bg-gray-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition">匯出 CSV</button>
                    <input type="file" id="csv-import-input" class="hidden" accept=".csv">
                </div>
                <p class="text-xs text-slate-500 mt-2 text-center">CSV 格式: qrCodeData,household,name,ownership (UTF-8 編碼)</p>
            </div>
        </main>
    </div>

    <!-- Add Event Modal -->
    <div id="add-event-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-20 mx-auto p-5 border w-full max-w-sm shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <h3 class="text-lg leading-6 font-medium text-gray-900">新增報到活動</h3>
                <div class="mt-4 px-7 py-3">
                    <input type="text" id="new-event-name" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="請輸入活動名稱">
                    <p id="event-error-msg" class="text-red-500 text-sm mt-2 h-4 text-left"></p>
                </div>
                <div class="items-center px-4 py-3 space-x-2">
                    <button id="cancel-event-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500">取消</button>
                    <button id="save-event-btn" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">儲存</button>
                </div>
            </div>
        </div>
    </div>

    <footer class="text-center mt-8 text-slate-500 text-sm">
        <p>&copy; 2025 智能社區管理系統. All Rights Reserved.</p>
    </footer>

    <script>
        // --- 模擬後端資料庫 ---
        let residents = {
            "A001ADDT": { household: "A001", name: "王大明", ownership: 1.25 },
            "A002ADDT": { household: "A002", name: "陳小姐", ownership: 0.88 },
            "A003ADDT": { household: "A003", name: "李先生", ownership: 2.10 },
        };
        // 用來記錄每個活動的報到狀況
        let attendance = {};

        // --- DOM 元素 ---
        const resultCard = document.getElementById('scan-result-card');
        const resultTitle = document.getElementById('result-title');
        const resultMessage = document.getElementById('result-message');
        const manualInput = document.getElementById('manual-input');
        const manualSubmitBtn = document.getElementById('manual-submit');
        const eventSelect = document.getElementById('event-select');
        const addEventBtn = document.getElementById('add-event-btn');
        const addEventModal = document.getElementById('add-event-modal');
        const newEventNameInput = document.getElementById('new-event-name');
        const saveEventBtn = document.getElementById('save-event-btn');
        const cancelEventBtn = document.getElementById('cancel-event-btn');
        const eventErrorMsg = document.getElementById('event-error-msg');
        const importCsvBtn = document.getElementById('import-csv-btn');
        const exportCsvBtn = document.getElementById('export-csv-btn');
        const csvImportInput = document.getElementById('csv-import-input');
        // Stats elements
        const statsTotal = document.getElementById('stats-total');
        const statsAttended = document.getElementById('stats-attended');
        const statsAbsent = document.getElementById('stats-absent');
        const statsOwnership = document.getElementById('stats-ownership');
        const quorumInput = document.getElementById('quorum-input');
        const quorumStatus = document.getElementById('quorum-status');


        // --- 音效模組 ---
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();

        function playSound(type) {
            if(type === 'quorumMet') {
                playSound('success'); 
                setTimeout(() => playSound('success'), 200);
                return;
            }
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            gainNode.gain.setValueAtTime(0, audioContext.currentTime);
            gainNode.gain.linearRampToValueAtTime(0.5, audioContext.currentTime + 0.01);

            if (type === 'success') {
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(523.25, audioContext.currentTime); // C5
                setTimeout(() => oscillator.frequency.setValueAtTime(659.25, audioContext.currentTime), 100); // E5
            } else if (type === 'warning') {
                oscillator.type = 'triangle';
                oscillator.frequency.setValueAtTime(440, audioContext.currentTime);
                setTimeout(() => oscillator.frequency.setValueAtTime(349.23, audioContext.currentTime), 100);
            } else { // error
                oscillator.type = 'square';
                oscillator.frequency.setValueAtTime(261.63, audioContext.currentTime);
            }

            oscillator.start(audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.00001, audioContext.currentTime + 0.2);
            oscillator.stop(audioContext.currentTime + 0.2);
        }

        // --- 核心報到邏輯 ---
        function processCheckIn(qrCodeData) {
            const selectedEvent = eventSelect.value;
            if (!attendance[selectedEvent]) {
                attendance[selectedEvent] = {};
            }

            const resident = residents[qrCodeData];

            if (resident) {
                if (attendance[selectedEvent][qrCodeData]) {
                    const checkInTime = attendance[selectedEvent][qrCodeData].time;
                    showResult('warning', '重複報到', `${resident.household} ${resident.name} 已於 ${checkInTime} 報到。`);
                } else {
                    const now = new Date();
                    const timeString = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
                    attendance[selectedEvent][qrCodeData] = { ...resident, time: timeString };
                    showResult('success', '報到成功！', `${resident.household} ${resident.name}，歡迎您！`);
                    updateStats();
                }
            } else {
                showResult('error', '無效的 QR Code', '查無此住戶資料，請確認 QR Code 是否正確。');
            }
        }
        
        // --- 更新儀表板資訊 ---
        function updateStats() {
            const selectedEvent = eventSelect.value;
            const currentAttendance = attendance[selectedEvent] || {};

            const totalCount = Object.keys(residents).length;
            const attendedCount = Object.keys(currentAttendance).length;
            const absentCount = totalCount - attendedCount;

            let attendedOwnership = 0;
            for (const qrCode in currentAttendance) {
                if(residents[qrCode] && residents[qrCode].ownership) {
                    attendedOwnership += parseFloat(residents[qrCode].ownership);
                }
            }

            statsTotal.textContent = totalCount;
            statsAttended.textContent = attendedCount;
            statsAbsent.textContent = absentCount;
            statsOwnership.textContent = `${attendedOwnership.toFixed(2)}%`;

            // 法定人數檢查
            const quorumValue = parseFloat(quorumInput.value) || 0;
            const previouslyMet = quorumStatus.dataset.met === 'true';

            if (attendedOwnership >= quorumValue) {
                quorumStatus.textContent = '已達法定開會報到人數';
                quorumStatus.classList.remove('text-red-500');
                quorumStatus.classList.add('text-green-600');
                quorumStatus.dataset.met = 'true';
                if (!previouslyMet && quorumValue > 0) {
                     playSound('quorumMet');
                }
            } else {
                quorumStatus.textContent = '未達法定開會報到人數';
                quorumStatus.classList.remove('text-green-600');
                quorumStatus.classList.add('text-red-500');
                quorumStatus.dataset.met = 'false';
            }
        }


        // --- UI 更新函式 ---
        function showResult(type, title, message) {
            resultCard.classList.remove('bg-green-100', 'text-green-800', 'bg-yellow-100', 'text-yellow-800', 'bg-red-100', 'text-red-800', 'bg-blue-100', 'text-blue-800');

            let bgColor, textColor;
            switch (type) {
                case 'success': bgColor = 'bg-green-100'; textColor = 'text-green-800'; break;
                case 'warning': bgColor = 'bg-yellow-100'; textColor = 'text-yellow-800'; break;
                case 'error': bgColor = 'bg-red-100'; textColor = 'text-red-800'; break;
                case 'info': default: bgColor = 'bg-blue-100'; textColor = 'text-blue-800'; break;
            }

            resultCard.classList.add(bgColor, textColor, 'show');
            resultTitle.textContent = title;
            resultMessage.textContent = message;

            if(type !== 'info') playSound(type);

            setTimeout(() => { resultCard.classList.remove('show'); }, 5000);
        }
        
        // --- 活動管理 (Modal) ---
        function openEventModal() {
            newEventNameInput.value = '';
            eventErrorMsg.textContent = '';
            addEventModal.classList.remove('hidden');
            newEventNameInput.focus();
        }

        function closeEventModal() { addEventModal.classList.add('hidden'); }

        function saveNewEvent() {
            const newEventName = newEventNameInput.value.trim();
            eventErrorMsg.textContent = ''; 

            if (!newEventName) { eventErrorMsg.textContent = '活動名稱不可為空。'; return; }

            const existingOptions = Array.from(eventSelect.options).map(opt => opt.value);
            if (existingOptions.includes(newEventName)) { eventErrorMsg.textContent = '此活動名稱已存在。'; return; }

            const newOption = document.createElement('option');
            newOption.value = newEventName;
            newOption.textContent = newEventName;
            eventSelect.appendChild(newOption);
            eventSelect.value = newEventName;
            
            closeEventModal();
        }

        // --- 手動報到處理 ---
        manualSubmitBtn.addEventListener('click', () => {
            const inputHousehold = manualInput.value.trim().toUpperCase();
            if (!inputHousehold) { showResult('error', '輸入錯誤', '戶號不能為空。'); return; }
            const foundQrCode = Object.keys(residents).find(key => residents[key].household.toUpperCase() === inputHousehold);
            if (foundQrCode) {
                processCheckIn(foundQrCode);
            } else {
                showResult('error', '查無此戶', `找不到戶號為 ${inputHousehold} 的住戶。`);
            }
            manualInput.value = '';
        });

        // --- CSV 資料處理 ---
        function exportToCSV() {
            const headers = ['qrCodeData', 'household', 'name', 'ownership'];
            let csvContent = '\uFEFF' + headers.join(',') + '\r\n';

            for (const [qrCode, data] of Object.entries(residents)) {
                const row = [qrCode, data.household, data.name, data.ownership];
                csvContent += row.join(',') + '\r\n';
            }

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", "resident_data.csv");
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
            showResult('info', '資料匯出', '住戶資料已開始下載。');
        }

        function importFromCSV(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result;
                const lines = text.split(/\r\n|\n/);

                if (lines.length < 2) { showResult('error', '匯入失敗', 'CSV 檔案是空的或格式不正確。'); return; }
                
                const headers = lines[0].replace(/^\uFEFF/, '').split(',').map(h => h.trim());
                if (headers[0] !== 'qrCodeData' || headers[1] !== 'household' || headers[2] !== 'name' || headers[3] !== 'ownership') {
                     showResult('error', '匯入失敗', 'CSV 標頭應為 qrCodeData,household,name,ownership'); return;
                }

                const newResidents = {};
                let importedCount = 0;
                for (let i = 1; i < lines.length; i++) {
                    if (!lines[i]) continue;
                    const data = lines[i].split(',');
                    const qrCodeData = data[0]?.trim();
                    const household = data[1]?.trim();
                    const name = data[2]?.trim();
                    const ownership = parseFloat(data[3]?.trim());
                    if(qrCodeData && household && name && !isNaN(ownership)) {
                        newResidents[qrCodeData] = { household, name, ownership };
                        importedCount++;
                    }
                }
                
                residents = newResidents;
                attendance = {};
                updateStats(); // 更新儀表板
                showResult('success', '匯入成功', `成功匯入 ${importedCount} 筆住戶資料。報到紀錄已重置。`);
            };
            reader.readAsText(file, 'UTF-8');
            csvImportInput.value = '';
        }

        // --- QR Code 掃描器設定 ---
        function onScanSuccess(decodedText, decodedResult) {
            if (window.lastScanTime && (Date.now() - window.lastScanTime < 3000)) return;
            window.lastScanTime = Date.now();
            processCheckIn(decodedText);
        }
        function onScanFailure(error) {}
        function initializeScanner() {
            const qrReaderDiv = document.getElementById('qr-reader');
            qrReaderDiv.innerHTML = "<div class='text-slate-500'>正在啟動攝影機...</div>"; 
            const html5QrcodeScanner = new Html5Qrcode("qr-reader");

            Html5Qrcode.getCameras().then(devices => {
                if (devices && devices.length) {
                    html5QrcodeScanner.start(
                        { facingMode: "environment" }, { fps: 10, qrbox: (w, h) => ({ width: Math.floor(Math.min(w, h) * 0.7), height: Math.floor(Math.min(w, h) * 0.7) })},
                        onScanSuccess, onScanFailure
                    ).catch(err => {
                        console.error("無法啟動掃描器", err);
                        qrReaderDiv.innerHTML = `<div class="p-4 text-center text-red-500">無法啟動攝影機，請檢查權限。</div>`;
                    });
                } else {
                     qrReaderDiv.innerHTML = `<div class="p-4">找不到攝影機。</div>`;
                }
            }).catch(err => {
                console.error("請求攝影機權限時發生錯誤", err);
                qrReaderDiv.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-full text-red-600 p-4 text-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-16 h-16 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 10.5l4.72-4.72a.75.75 0 011.28.53v11.38a.75.75 0 01-1.28.53l-4.72-4.72M4.5 18.75h10.5a2.25 2.25 0 002.25-2.25v-9a2.25 2.25 0 00-2.25-2.25H4.5A2.25 2.25 0 002.25 7.5v9a2.25 2.25 0 002.25 2.25z" /><path stroke-linecap="round" stroke-linejoin="round" d="M3 3l18 18" /></svg>
                        <p class="text-xl font-bold mb-2">攝影機權限已被封鎖</p>
                        <div class="bg-red-100 p-3 rounded-lg"><p class="text-lg font-semibold text-slate-800">請點擊網址列左邊的圖示 (🔒)，<br>並將「攝影機」權限設為「<b>允許</b>」。</p></div>
                        <button id="retry-camera-btn" class="mt-6 bg-indigo-600 text-white font-semibold py-2 px-6 rounded-md hover:bg-indigo-700 text-lg">設定完成後，點此重試</button>
                    </div>`;
                document.getElementById('retry-camera-btn').addEventListener('click', initializeScanner);
            });
        }

        document.addEventListener('DOMContentLoaded', (event) => {
            initializeScanner();
            updateStats();
            
            addEventBtn.addEventListener('click', openEventModal);
            cancelEventBtn.addEventListener('click', closeEventModal);
            saveEventBtn.addEventListener('click', saveNewEvent);
            addEventModal.addEventListener('click', (e) => { if (e.target === addEventModal) closeEventModal(); });
            newEventNameInput.addEventListener('keyup', (e) => { if (e.key === 'Enter') saveNewEvent(); });
            
            exportCsvBtn.addEventListener('click', exportToCSV);
            importCsvBtn.addEventListener('click', () => csvImportInput.click());
            csvImportInput.addEventListener('change', importFromCSV);

            quorumInput.addEventListener('input', updateStats);
            eventSelect.addEventListener('change', updateStats);
        });
    </script>
</body>
</html>
