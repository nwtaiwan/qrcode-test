<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>社區 QR Code 智能報到系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html5-qrcode/html5-qrcode.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            overscroll-behavior: none;
        }
        #qr-reader {
            border: 2px dashed #a7a7a7;
            border-radius: 1rem;
            overflow: hidden;
            transform: translateZ(0);
        }
        .scan-result-card {
            transition: all 0.3s ease-in-out;
            transform: translateY(20px);
            opacity: 0;
            visibility: hidden;
        }
        .scan-result-card.show {
            transform: translateY(0);
            opacity: 1;
            visibility: visible;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-slate-100 flex flex-col items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-2xl mx-auto bg-white rounded-2xl shadow-xl p-6 md:p-8">
        <header class="text-center mb-6">
            <h1 class="text-3xl font-bold text-slate-800">社區智能報到系統</h1>
            <p id="system-status" class="text-slate-500 mt-2">正在連線至即時同步伺服器...</p>
        </header>

        <main>
            <!-- 攝影機掃描區 -->
            <div id="qr-reader" class="w-full aspect-video md:aspect-[4/3] bg-slate-200 flex items-center justify-center">
                <div class="text-slate-500">正在啟動攝影機...</div>
            </div>
            
            <!-- 報到活動選擇 -->
            <div class="mt-6">
                <label for="event-select" class="block text-sm font-medium text-slate-700 mb-1">目前活動:</label>
                <div class="flex items-center gap-2">
                    <select id="event-select" class="block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md shadow-sm">
                        <option>載入活動中...</option>
                    </select>
                    <button id="add-event-btn" title="新增活動" class="flex-shrink-0 p-2 bg-indigo-100 text-indigo-700 rounded-full hover:bg-indigo-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" />
                        </svg>
                    </button>
                </div>
            </div>
            
            <!-- 掃描結果顯示區 -->
            <div id="scan-result-card" class="scan-result-card mt-6 p-5 rounded-lg shadow-md">
                <h3 id="result-title" class="text-xl font-bold text-center"></h3>
                <p id="result-message" class="text-center mt-2"></p>
            </div>

            <!-- 報到即時資訊 -->
            <div class="mt-6 border-t pt-4">
                 <div class="flex justify-center items-center mb-3">
                    <p class="text-center text-slate-600 font-semibold">報到即時資訊</p>
                    <div id="loading-spinner" class="loader ml-4 hidden"></div>
                </div>
                <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 text-center">
                    <div>
                        <p class="text-sm text-slate-500">應到人數</p>
                        <p id="stats-total" class="text-2xl font-bold text-slate-800">0</p>
                    </div>
                    <div>
                        <p class="text-sm text-slate-500">實到人數</p>
                        <p id="stats-attended" class="text-2xl font-bold text-blue-600">0</p>
                    </div>
                    <div>
                        <p class="text-sm text-slate-500">未到人數</p>
                        <p id="stats-absent" class="text-2xl font-bold text-orange-500">0</p>
                    </div>
                    <div>
                        <p class="text-sm text-slate-500">實到區分權</p>
                        <p id="stats-ownership" class="text-2xl font-bold text-green-600">0.00%</p>
                    </div>
                </div>
                <div class="mt-4 flex flex-col sm:flex-row items-center justify-center gap-2 bg-slate-50 p-3 rounded-lg">
                    <label for="quorum-input" class="text-sm font-medium text-slate-700">法定區分權比例(%):</label>
                    <input type="number" id="quorum-input" value="66.67" class="w-24 px-2 py-1 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    <p id="quorum-status" class="text-lg font-bold ml-2"></p>
                </div>
            </div>


            <!-- 手動輸入區 -->
            <div class="mt-6 border-t pt-4">
                 <p class="text-center text-slate-600 mb-2">無法掃描？</p>
                <div class="flex flex-col sm:flex-row gap-2">
                    <input type="text" id="manual-input" placeholder="請輸入戶號，例如: A001" class="flex-grow w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    <button id="manual-submit" class="w-full sm:w-auto bg-indigo-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition">
                        手動報到
                    </button>
                </div>
            </div>

            <!-- 資料管理區 -->
            <div class="mt-6 border-t pt-4">
                <p class="text-center text-slate-600 mb-3 font-semibold">住戶資料管理</p>
                <div class="flex flex-col sm:flex-row gap-2">
                    <button id="import-csv-btn" class="flex-1 bg-blue-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition">匯入 CSV</button>
                    <button id="export-csv-btn" class="flex-1 bg-gray-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition">匯出 CSV</button>
                    <input type="file" id="csv-import-input" class="hidden" accept=".csv">
                </div>
                <p class="text-xs text-slate-500 mt-2 text-center">CSV 格式: qrCodeData,household,name,ownership (UTF-8 編碼)</p>
            </div>
        </main>
    </div>

    <!-- Add Event Modal -->
    <div id="add-event-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-20 mx-auto p-5 border w-full max-w-sm shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <h3 class="text-lg leading-6 font-medium text-gray-900">新增報到活動</h3>
                <div class="mt-4 px-7 py-3">
                    <input type="text" id="new-event-name" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="請輸入活動名稱">
                    <p id="event-error-msg" class="text-red-500 text-sm mt-2 h-4 text-left"></p>
                </div>
                <div class="items-center px-4 py-3 space-x-2">
                    <button id="cancel-event-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500">取消</button>
                    <button id="save-event-btn" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">儲存</button>
                </div>
            </div>
        </div>
    </div>

    <footer class="text-center mt-8 text-slate-500 text-sm">
        <p>&copy; 2025 智能社區管理系統. All Rights Reserved.</p>
    </footer>
    
    <script type="module">
        // --- Firebase SDK ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, addDoc, getDocs, deleteDoc, onSnapshot, collection, query, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- 全域變數 ---
        let db, auth;
        let residents = {}; // 本地快取住戶資料
        let attendanceUnsubscribe = null; // 用於取消即時監聽
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-check-in-app';

        // --- DOM 元素 ---
        const systemStatus = document.getElementById('system-status');
        const resultCard = document.getElementById('scan-result-card');
        const resultTitle = document.getElementById('result-title');
        const resultMessage = document.getElementById('result-message');
        const manualInput = document.getElementById('manual-input');
        const manualSubmitBtn = document.getElementById('manual-submit');
        const eventSelect = document.getElementById('event-select');
        const addEventBtn = document.getElementById('add-event-btn');
        const addEventModal = document.getElementById('add-event-modal');
        const newEventNameInput = document.getElementById('new-event-name');
        const saveEventBtn = document.getElementById('save-event-btn');
        const cancelEventBtn = document.getElementById('cancel-event-btn');
        const eventErrorMsg = document.getElementById('event-error-msg');
        const importCsvBtn = document.getElementById('import-csv-btn');
        const exportCsvBtn = document.getElementById('export-csv-btn');
        const csvImportInput = document.getElementById('csv-import-input');
        const statsTotal = document.getElementById('stats-total');
        const statsAttended = document.getElementById('stats-attended');
        const statsAbsent = document.getElementById('stats-absent');
        const statsOwnership = document.getElementById('stats-ownership');
        const quorumInput = document.getElementById('quorum-input');
        const quorumStatus = document.getElementById('quorum-status');
        const loadingSpinner = document.getElementById('loading-spinner');

        // --- 音效模組 ---
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        function playSound(type) {
            // ... (音效程式碼與之前相同，此處省略以保持簡潔)
        }

        // --- 核心報到邏輯 (Firebase) ---
        async function processCheckIn(qrCodeData) {
            const selectedEvent = eventSelect.value;
            if (!selectedEvent) {
                showResult('error', '錯誤', '請先選擇一個報到活動。');
                return;
            }

            const resident = residents[qrCodeData];
            if (!resident) {
                showResult('error', '無效的 QR Code', '查無此住戶資料，請確認 QR Code 是否正確。');
                return;
            }

            const eventAttendanceRef = collection(db, 'apps', appId, 'events', selectedEvent, 'attendance');
            const residentDocRef = doc(eventAttendanceRef, qrCodeData);

            try {
                const docSnap = await getDoc(residentDocRef);
                if (docSnap.exists()) {
                    const checkInTime = docSnap.data().time;
                    showResult('warning', '重複報到', `${resident.household} ${resident.name} 已於 ${checkInTime} 報到。`);
                } else {
                    const now = new Date();
                    const timeString = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
                    await setDoc(residentDocRef, { ...resident, time: timeString });
                    showResult('success', '報到成功！', `${resident.household} ${resident.name}，歡迎您！`);
                    // 資料更新將由 onSnapshot 自動觸發，不需手動呼叫 updateStats
                }
            } catch (error) {
                console.error("報到時發生錯誤:", error);
                showResult('error', '系統錯誤', '報到失敗，請稍後再試。');
            }
        }

        // --- 更新儀表板資訊 ---
        function updateStats(currentAttendance = {}) {
            const totalCount = Object.keys(residents).length;
            const attendedCount = Object.keys(currentAttendance).length;
            const absentCount = totalCount - attendedCount;
            let attendedOwnership = 0;
            for (const qrCode in currentAttendance) {
                if(residents[qrCode] && residents[qrCode].ownership) {
                    attendedOwnership += parseFloat(residents[qrCode].ownership);
                }
            }
            statsTotal.textContent = totalCount;
            statsAttended.textContent = attendedCount;
            statsAbsent.textContent = absentCount;
            statsOwnership.textContent = `${attendedOwnership.toFixed(2)}%`;
            
            const quorumValue = parseFloat(quorumInput.value) || 0;
            const previouslyMet = quorumStatus.dataset.met === 'true';
            if (attendedOwnership >= quorumValue) {
                quorumStatus.textContent = '已達法定開會報到人數';
                quorumStatus.classList.remove('text-red-500');
                quorumStatus.classList.add('text-green-600');
                quorumStatus.dataset.met = 'true';
                if (!previouslyMet && quorumValue > 0) playSound('quorumMet');
            } else {
                quorumStatus.textContent = '未達法定開會報到人數';
                quorumStatus.classList.remove('text-green-600');
                quorumStatus.classList.add('text-red-500');
                quorumStatus.dataset.met = 'false';
            }
            loadingSpinner.classList.add('hidden');
        }
        
        // --- 設定對特定活動報到狀況的即時監聽 ---
        function listenForAttendanceChanges() {
            if (attendanceUnsubscribe) {
                attendanceUnsubscribe(); // 取消先前的監聽
            }
            const selectedEvent = eventSelect.value;
            if (!selectedEvent) {
                 updateStats({}); // 如果沒有活動，清空數據
                 return;
            }
            
            loadingSpinner.classList.remove('hidden');
            const eventAttendanceRef = collection(db, 'apps', appId, 'events', selectedEvent, 'attendance');
            attendanceUnsubscribe = onSnapshot(eventAttendanceRef, (querySnapshot) => {
                const currentAttendance = {};
                querySnapshot.forEach((doc) => {
                    currentAttendance[doc.id] = doc.data();
                });
                updateStats(currentAttendance);
            }, (error) => {
                console.error("監聽報到資料時發生錯誤:", error);
                showResult('error', '連線錯誤', '無法即時更新報到狀態。');
                loadingSpinner.classList.add('hidden');
            });
        }
        
        // --- 載入住戶資料 ---
        async function loadResidents() {
             const residentsRef = collection(db, 'apps', appId, 'residents');
             const querySnapshot = await getDocs(residentsRef);
             residents = {};
             querySnapshot.forEach((doc) => {
                 residents[doc.id] = doc.data();
             });
             updateStats(); // 用空的報到紀錄更新一次儀表板
        }

        // --- 載入活動列表 ---
        async function loadEvents() {
            const eventsRef = collection(db, 'apps', appId, 'events');
            const q = query(eventsRef);
            onSnapshot(q, (querySnapshot) => {
                const currentSelectedValue = eventSelect.value;
                eventSelect.innerHTML = '';
                if (querySnapshot.empty) {
                    eventSelect.innerHTML = '<option>尚無活動</option>';
                } else {
                     querySnapshot.forEach((doc) => {
                        const option = document.createElement('option');
                        option.value = doc.id;
                        option.textContent = doc.id;
                        eventSelect.appendChild(option);
                    });
                }
                
                // 嘗試恢復之前的選擇
                if (Array.from(eventSelect.options).some(opt => opt.value === currentSelectedValue)) {
                    eventSelect.value = currentSelectedValue;
                }
                
                listenForAttendanceChanges(); // 重新綁定監聽
            });
        }
        
        // --- CSV 資料處理 (Firebase) ---
        async function exportToCSV() {
            await loadResidents(); // 確保本地快取是最新
            const headers = ['qrCodeData', 'household', 'name', 'ownership'];
            let csvContent = '\uFEFF' + headers.join(',') + '\r\n';
            for (const [qrCode, data] of Object.entries(residents)) {
                const row = [qrCode, data.household, data.name, data.ownership];
                csvContent += row.join(',') + '\r\n';
            }
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = "resident_data.csv";
            link.click();
            URL.revokeObjectURL(link.href);
            showResult('info', '資料匯出', '住戶資料已開始下載。');
        }

        async function importFromCSV(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async function(e) {
                const text = e.target.result;
                const lines = text.split(/\r\n|\n/);
                if (lines.length < 2) { showResult('error', '匯入失敗', 'CSV 檔案是空的。'); return; }
                const headers = lines[0].replace(/^\uFEFF/, '').split(',').map(h => h.trim());
                if (headers.join(',') !== 'qrCodeData,household,name,ownership') {
                     showResult('error', '匯入失敗', 'CSV 標頭應為 qrCodeData,household,name,ownership'); return;
                }
                
                try {
                    const batch = writeBatch(db);
                    const residentsRef = collection(db, 'apps', appId, 'residents');
                    // 可選：先刪除所有舊資料
                    // const oldDocs = await getDocs(residentsRef);
                    // oldDocs.forEach(doc => batch.delete(doc.ref));

                    let importedCount = 0;
                    for (let i = 1; i < lines.length; i++) {
                        if (!lines[i]) continue;
                        const data = lines[i].split(',');
                        const qrCodeData = data[0]?.trim();
                        const household = data[1]?.trim();
                        const name = data[2]?.trim();
                        const ownership = parseFloat(data[3]?.trim());
                        if(qrCodeData && household && name && !isNaN(ownership)) {
                            const docRef = doc(residentsRef, qrCodeData);
                            batch.set(docRef, { household, name, ownership });
                            importedCount++;
                        }
                    }
                    await batch.commit();
                    await loadResidents(); // 重新載入
                    showResult('success', '匯入成功', `成功匯入 ${importedCount} 筆住戶資料。`);
                } catch(error) {
                    console.error("CSV 匯入錯誤:", error);
                    showResult('error', '匯入失敗', '寫入資料庫時發生錯誤。');
                }
            };
            reader.readAsText(file, 'UTF-8');
            csvImportInput.value = '';
        }
        
        // --- UI & Event Listeners ---
        // ... (Modal, 手動報到等 UI 邏輯與之前類似，此處省略)

        // --- Firebase 初始化 ---
        document.addEventListener('DOMContentLoaded', async () => {
            initializeScanner();
            try {
                const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        systemStatus.textContent = '已連線，請將住戶的 QR Code 對準掃描框';
                        await loadResidents();
                        await loadEvents();
                    }
                });

                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }

            } catch (error) {
                console.error("Firebase 初始化失敗:", error);
                systemStatus.textContent = '無法連線至同步伺服器，將以單機模式運作。';
                // 可在此處加入降級為單機模式的邏輯
            }
             
            eventSelect.addEventListener('change', listenForAttendanceChanges);
            quorumInput.addEventListener('input', () => updateStats()); // 法定比例變動時也更新狀態
            importCsvBtn.addEventListener('click', () => csvImportInput.click());
            csvImportInput.addEventListener('change', importFromCSV);
            exportCsvBtn.addEventListener('click', exportToCSV);
            // 其他按鈕事件綁定...
        });

        // --- QR Code 掃描器設定 ---
        function onScanSuccess(decodedText, decodedResult) {
            // ... (與之前相同)
        }
        function onScanFailure(error) {}
        function initializeScanner() {
            // ... (與之前相同)
        }
    </script>
</body>
</html>
