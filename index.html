<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>社區 QR Code 報到系統</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- QR Code generation library -->
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <!-- QR Code scanning library -->
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

    <style>
        /* Custom styles */
        body {
            font-family: 'Inter', '微軟正黑體', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        .tab-button {
            @apply px-4 py-2 text-sm font-medium text-gray-500 border-b-2 border-transparent hover:text-blue-600 hover:border-blue-600 focus:outline-none;
        }
        .tab-button.active {
            @apply text-blue-600 border-blue-600;
        }
        #reader {
            width: 100%;
            border: 2px solid #e5e7eb;
            border-radius: 0.5rem;
            overflow: hidden;
        }
        /* Custom animation for feedback messages */
        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateY(-20px); }
            10%, 90% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-20px); }
        }
        .feedback-animation {
            animation: fadeInOut 3s ease-in-out forwards;
        }
        /* Print-friendly styles for QR codes */
        @media print {
            body * {
                visibility: hidden;
            }
            #qr-code-print-area, #qr-code-print-area * {
                visibility: visible;
            }
            #qr-code-print-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
            .qr-code-item {
                page-break-inside: avoid;
            }
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">

    <div id="app" class="w-full max-w-4xl mx-auto bg-white shadow-lg rounded-lg overflow-hidden">

        <!-- ===== Login View ===== -->
        <div id="login-view" class="p-8">
            <div class="text-center mb-8">
                <i class="fas fa-qrcode text-5xl text-blue-600"></i>
                <h1 class="text-3xl font-bold text-gray-800 mt-4">社區報到系統後台</h1>
                <p class="text-gray-500">請登入以管理報到活動</p>
            </div>
            
            <div class="max-w-sm mx-auto">
                <div class="mb-4">
                    <label for="email" class="block text-sm font-medium text-gray-700">電子郵件</label>
                    <input type="email" id="email" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="your.email@example.com">
                </div>
                <div class="mb-6">
                    <label for="password" class="block text-sm font-medium text-gray-700">密碼</label>
                    <input type="password" id="password" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="********">
                </div>
                <div id="auth-error" class="text-red-500 text-sm mb-4 text-center hidden"></div>
                <div class="flex flex-col sm:flex-row gap-2">
                    <button id="login-btn" class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 ease-in-out">登入</button>
                    <button id="register-btn" class="w-full bg-gray-200 text-gray-800 py-2 px-4 rounded-md hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400 transition duration-150 ease-in-out">註冊新帳號</button>
                </div>
            </div>
        </div>

        <!-- ===== Main App View ===== -->
        <div id="main-view" class="hidden">
            <!-- Header -->
            <header class="bg-gray-50 p-4 border-b flex justify-between items-center">
                <div>
                    <h2 id="header-community-name" class="text-xl font-bold text-gray-800">社區名稱</h2>
                    <p id="header-event-name" class="text-sm text-gray-500">會議活動</p>
                </div>
                <button id="logout-btn" class="text-gray-500 hover:text-red-600 focus:outline-none">
                    <i class="fas fa-sign-out-alt mr-1"></i>登出
                </button>
            </header>

            <!-- Tabs -->
            <nav class="border-b">
                <div class="flex -mb-px px-4" id="tabs">
                    <button data-tab="setup" class="tab-button active"><i class="fas fa-cog mr-2"></i>活動設定</button>
                    <button data-tab="residents" class="tab-button"><i class="fas fa-users mr-2"></i>住戶管理</button>
                    <button data-tab="scanner" class="tab-button"><i class="fas fa-qrcode mr-2"></i>掃碼報到</button>
                    <button data-tab="status" class="tab-button"><i class="fas fa-chart-pie mr-2"></i>報到狀況</button>
                </div>
            </nav>

            <!-- Tab Content -->
            <main id="tab-content" class="p-6" style="min-height: 60vh;">
                <!-- Setup Tab -->
                <div id="setup-tab" class="tab-pane">
                    <h3 class="text-2xl font-semibold mb-4 text-gray-700">活動設定</h3>
                    <div class="space-y-4 max-w-lg">
                        <div>
                            <label for="community-name" class="block text-sm font-medium text-gray-700">社區名稱</label>
                            <input type="text" id="community-name" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="event-name" class="block text-sm font-medium text-gray-700">會議/活動名稱</label>
                            <input type="text" id="event-name" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="event-date" class="block text-sm font-medium text-gray-700">日期與時間</label>
                            <input type="datetime-local" id="event-date" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <button id="save-config-btn" class="bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">儲存設定</button>
                        <p id="config-feedback" class="text-green-600 text-sm mt-2"></p>
                    </div>
                </div>

                <!-- Residents Tab -->
                <div id="residents-tab" class="tab-pane hidden">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-2xl font-semibold text-gray-700">住戶管理</h3>
                        <button id="view-qrcodes-btn" class="bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500"><i class="fas fa-print mr-2"></i>產生 & 列印 QR Code</button>
                    </div>
                    <!-- Add Resident Form -->
                    <div class="bg-gray-50 p-4 rounded-lg mb-6">
                        <h4 class="font-semibold mb-2">新增住戶</h4>
                        <form id="add-resident-form" class="flex flex-col sm:flex-row gap-4 items-end">
                            <div class="flex-grow w-full">
                                <label for="resident-household" class="block text-sm font-medium text-gray-700">戶號 (例如: A-101)</label>
                                <input type="text" id="resident-household" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                            </div>
                            <div class="flex-grow w-full">
                                <label for="resident-name" class="block text-sm font-medium text-gray-700">住戶姓名</label>
                                <input type="text" id="resident-name" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                            </div>
                            <button type="submit" class="w-full sm:w-auto bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">新增</button>
                        </form>
                    </div>
                    <!-- Resident List -->
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white rounded-lg shadow">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="text-left py-3 px-4 font-semibold text-sm">戶號</th>
                                    <th class="text-left py-3 px-4 font-semibold text-sm">姓名</th>
                                    <th class="text-left py-3 px-4 font-semibold text-sm">操作</th>
                                </tr>
                            </thead>
                            <tbody id="resident-list" class="text-gray-700">
                                <!-- Resident rows will be inserted here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Scanner Tab -->
                <div id="scanner-tab" class="tab-pane hidden">
                     <div class="flex flex-col md:flex-row gap-6">
                        <div class="w-full md:w-1/2">
                            <h3 class="text-2xl font-semibold mb-2 text-gray-700">掃碼報到</h3>
                            <p class="text-gray-500 mb-4">將住戶的 QR code 對準下方掃描框</p>
                            <div id="reader-container" class="relative">
                                <div id="reader"></div>
                                <div id="feedback-overlay" class="absolute inset-0 flex items-center justify-center pointer-events-none"></div>
                            </div>
                            <div id="scanner-error" class="text-red-500 mt-2"></div>
                            <button id="stop-scanner-btn" class="hidden mt-4 w-full bg-red-600 text-white py-2 px-4 rounded-md hover:bg-red-700">停止掃描</button>
                        </div>
                        <div class="w-full md:w-1/2">
                            <h4 class="text-xl font-semibold mb-4 text-gray-700">最近報到紀錄</h4>
                            <div id="scan-log" class="space-y-2 h-96 overflow-y-auto bg-gray-50 p-3 rounded-lg">
                                <!-- Scan log entries will be here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Status Tab -->
                <div id="status-tab" class="tab-pane hidden">
                    <h3 class="text-2xl font-semibold mb-4 text-gray-700">即時報到狀況</h3>
                    <div class="bg-gray-50 p-4 rounded-lg mb-6 shadow">
                        <div class="flex justify-around text-center">
                            <div>
                                <p class="text-sm text-gray-500">總戶數</p>
                                <p id="total-residents" class="text-3xl font-bold text-gray-800">0</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500">已報到</p>
                                <p id="checked-in-count" class="text-3xl font-bold text-green-600">0</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500">報到率</p>
                                <p id="check-in-percentage" class="text-3xl font-bold text-blue-600">0%</p>
                            </div>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2.5 mt-4">
                            <div id="progress-bar" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white rounded-lg shadow">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="text-left py-3 px-4 font-semibold text-sm">戶號</th>
                                    <th class="text-left py-3 px-4 font-semibold text-sm">姓名</th>
                                    <th class="text-left py-3 px-4 font-semibold text-sm">報到狀態</th>
                                    <th class="text-left py-3 px-4 font-semibold text-sm">報到時間</th>
                                </tr>
                            </thead>
                            <tbody id="status-list" class="text-gray-700">
                                <!-- Status rows will be inserted here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </main>
        </div>

        <!-- QR Code Modal -->
        <div id="qrcode-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
            <div class="bg-white rounded-lg shadow-xl w-11/12 max-w-5xl max-h-[90vh] flex flex-col">
                <div class="p-4 border-b flex justify-between items-center">
                    <h3 class="text-xl font-semibold">住戶 QR Code</h3>
                    <div>
                        <button id="print-qrcodes-btn" class="mr-2 bg-blue-600 text-white py-1 px-3 rounded-md hover:bg-blue-700"><i class="fas fa-print mr-1"></i>列印</button>
                        <button id="close-qrcode-modal-btn" class="text-gray-500 hover:text-gray-800">&times;</button>
                    </div>
                </div>
                <div id="qr-code-print-area" class="p-6 overflow-y-auto">
                    <div id="qrcode-list" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                        <!-- QR codes will be inserted here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Confirmation Modal -->
        <div id="confirm-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
            <div class="bg-white rounded-lg shadow-xl w-11/12 max-w-sm p-6">
                <h3 id="confirm-modal-title" class="text-lg font-semibold text-gray-800 mb-4">確定要執行此操作嗎？</h3>
                <p id="confirm-modal-text" class="text-gray-600 mb-6">此動作無法復原。</p>
                <div class="flex justify-end gap-4">
                    <button id="confirm-modal-cancel-btn" class="bg-gray-200 text-gray-800 py-2 px-4 rounded-md hover:bg-gray-300">取消</button>
                    <button id="confirm-modal-ok-btn" class="bg-red-600 text-white py-2 px-4 rounded-md hover:bg-red-700">確定刪除</button>
                </div>
            </div>
        </div>

    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            onAuthStateChanged, 
            signOut 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            setDoc, 
            addDoc, 
            collection, 
            onSnapshot,
            query,
            updateDoc,
            deleteDoc,
            serverTimestamp
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Configuration ---
        // IMPORTANT: 請在此處貼上您自己的 Firebase 設定物件
        // 1. 前往 https://console.firebase.google.com/ 建立一個新的 Firebase 專案。
        // 2. 在您的專案中，建立一個「網頁」應用程式。
        // 3. Firebase 會提供一組設定碼 (firebaseConfig)，請將其複製並貼到下方。
        // 4. 在 Firebase 主控台中，前往「Authentication」->「Sign-in method」，啟用「電子郵件/密碼」登入方式。
        // 5. 前往「Firestore Database」，建立一個資料庫，並設定安全規則為測試模式 (允許讀寫) 以便開始。
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-qr-checkin';
        
        // --- App Initialization ---
        const loginView = document.getElementById('login-view');

        // 檢查 firebaseConfig 是否已填寫
        if (firebaseConfig.apiKey === "YOUR_API_KEY" && typeof __firebase_config === 'undefined') {
            loginView.innerHTML = `
                <div class="p-8 text-center bg-red-50 rounded-lg">
                    <h1 class="text-2xl font-bold text-red-700">設定錯誤</h1>
                    <p class="mt-2 text-gray-800">
                        Firebase 設定尚未完成。請編輯此 HTML 檔案，
                        在 &lt;script type="module"&gt; 區塊中填入您自己的 Firebase 設定碼 (firebaseConfig)。
                    </p>
                    <p class="mt-4 text-sm text-gray-600">
                        詳細步驟請參考程式碼內的註解說明。
                    </p>
                </div>
            `;
            throw new Error("Firebase config is not set. Please update the firebaseConfig object in the script.");
        }
        
        const finalFirebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : firebaseConfig;
        const app = initializeApp(finalFirebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- DOM Elements ---
        const mainView = document.getElementById('main-view');
        const authError = document.getElementById('auth-error');
        const confirmModal = document.getElementById('confirm-modal');
        const confirmModalOkBtn = document.getElementById('confirm-modal-ok-btn');
        const confirmModalCancelBtn = document.getElementById('confirm-modal-cancel-btn');

        // --- State ---
        let currentUser = null;
        let configUnsubscribe = null;
        let residentsUnsubscribe = null;
        let html5QrCode = null;
        let confirmResolve = null;

        // --- Confirmation Modal Logic ---
        function showConfirmModal(title, text, confirmText = '確定') {
            return new Promise((resolve) => {
                document.getElementById('confirm-modal-title').textContent = title;
                document.getElementById('confirm-modal-text').textContent = text;
                confirmModalOkBtn.textContent = confirmText;
                confirmModal.classList.remove('hidden');
                confirmResolve = resolve;
            });
        }

        confirmModalOkBtn.addEventListener('click', () => {
            confirmModal.classList.add('hidden');
            if (confirmResolve) confirmResolve(true);
        });

        confirmModalCancelBtn.addEventListener('click', () => {
            confirmModal.classList.add('hidden');
            if (confirmResolve) confirmResolve(false);
        });

        // --- Authentication ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                loginView.classList.add('hidden');
                mainView.classList.remove('hidden');
                setupListeners();
            } else {
                currentUser = null;
                loginView.classList.remove('hidden');
                mainView.classList.add('hidden');
                cleanupListeners();
            }
        });

        document.getElementById('login-btn').addEventListener('click', () => {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            signInWithEmailAndPassword(auth, email, password)
                .catch(error => handleAuthError(error));
        });

        document.getElementById('register-btn').addEventListener('click', () => {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            createUserWithEmailAndPassword(auth, email, password)
                .catch(error => handleAuthError(error));
        });
        
        document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));

        function handleAuthError(error) {
            console.error("Authentication Error:", error);
            authError.classList.remove('hidden');
            switch (error.code) {
                case 'auth/invalid-email':
                    authError.textContent = '信箱格式錯誤。';
                    break;
                case 'auth/user-not-found':
                case 'auth/wrong-password':
                    authError.textContent = '信箱或密碼錯誤。';
                    break;
                case 'auth/email-already-in-use':
                    authError.textContent = '此信箱已被註冊。';
                    break;
                case 'auth/weak-password':
                    authError.textContent = '密碼強度不足，至少需要6個字元。';
                    break;
                default:
                    authError.textContent = '發生未知錯誤，請稍後再試。';
            }
        }
        
        // --- Firestore References ---
        const configRef = doc(db, `artifacts/${appId}/public/data/config/eventConfig`);
        const residentsColRef = collection(db, `artifacts/${appId}/public/data/residents`);

        // --- Data Listeners ---
        function setupListeners() {
            // Config Listener
            configUnsubscribe = onSnapshot(configRef, (docSnap) => {
                const configData = docSnap.exists() ? docSnap.data() : {};
                updateConfigUI(configData);
            });

            // Residents Listener
            const q = query(residentsColRef);
            residentsUnsubscribe = onSnapshot(q, (snapshot) => {
                const residents = [];
                snapshot.forEach(doc => residents.push({ id: doc.id, ...doc.data() }));
                updateResidentsUI(residents);
                updateStatusUI(residents);
            });
        }
        
        function cleanupListeners() {
            if (configUnsubscribe) configUnsubscribe();
            if (residentsUnsubscribe) residentsUnsubscribe();
        }

        // --- UI Updates ---
        function updateConfigUI(data) {
            document.getElementById('community-name').value = data.communityName || '';
            document.getElementById('event-name').value = data.eventName || '';
            document.getElementById('event-date').value = data.eventDate || '';
            document.getElementById('header-community-name').textContent = data.communityName || '尚未設定社區';
            document.getElementById('header-event-name').textContent = data.eventName || '尚未設定活動';
        }

        function updateResidentsUI(residents) {
            const list = document.getElementById('resident-list');
            list.innerHTML = ''; // Clear list
            residents.sort((a,b) => a.householdId.localeCompare(b.householdId)).forEach(res => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="py-3 px-4">${res.householdId}</td>
                    <td class="py-3 px-4">${res.name}</td>
                    <td class="py-3 px-4">
                        <button data-id="${res.id}" class="delete-resident-btn text-red-500 hover:text-red-700">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </td>
                `;
                list.appendChild(row);
            });
            // Update QR code modal as well
            updateQrCodeModal(residents);
        }

        function updateStatusUI(residents) {
            const total = residents.length;
            const checkedIn = residents.filter(r => r.isCheckedIn).length;
            const percentage = total > 0 ? Math.round((checkedIn / total) * 100) : 0;

            document.getElementById('total-residents').textContent = total;
            document.getElementById('checked-in-count').textContent = checkedIn;
            document.getElementById('check-in-percentage').textContent = `${percentage}%`;
            document.getElementById('progress-bar').style.width = `${percentage}%`;
            
            const list = document.getElementById('status-list');
            list.innerHTML = '';
            residents.sort((a,b) => a.householdId.localeCompare(b.householdId)).forEach(res => {
                const checkInTime = res.checkInTime ? new Date(res.checkInTime.seconds * 1000).toLocaleTimeString('zh-TW') : '---';
                const row = document.createElement('tr');
                row.className = res.isCheckedIn ? 'bg-green-50' : '';
                row.innerHTML = `
                    <td class="py-3 px-4">${res.householdId}</td>
                    <td class="py-3 px-4">${res.name}</td>
                    <td class="py-3 px-4">
                        <span class="px-2 py-1 text-xs rounded-full ${res.isCheckedIn ? 'bg-green-200 text-green-800' : 'bg-gray-200 text-gray-800'}">
                            ${res.isCheckedIn ? '已報到' : '未報到'}
                        </span>
                    </td>
                    <td class="py-3 px-4">${checkInTime}</td>
                `;
                list.appendChild(row);
            });
        }
        
        function updateQrCodeModal(residents) {
            const qrList = document.getElementById('qrcode-list');
            qrList.innerHTML = '';
            residents.sort((a,b) => a.householdId.localeCompare(b.householdId)).forEach(res => {
                const item = document.createElement('div');
                item.className = 'qr-code-item border p-4 rounded-lg text-center flex flex-col items-center justify-center';
                const qrContainer = document.createElement('div');
                qrContainer.id = `qr-${res.id}`;
                qrContainer.className = 'mb-2';
                item.appendChild(qrContainer);
                
                const info = document.createElement('p');
                info.className = 'font-semibold';
                info.textContent = `${res.householdId} ${res.name}`;
                item.appendChild(info);
                
                qrList.appendChild(item);

                // Generate QR Code
                new QRCode(qrContainer, {
                    text: res.id,
                    width: 128,
                    height: 128,
                });
            });
        }

        // --- Event Handlers ---
        document.getElementById('save-config-btn').addEventListener('click', async () => {
            const configData = {
                communityName: document.getElementById('community-name').value,
                eventName: document.getElementById('event-name').value,
                eventDate: document.getElementById('event-date').value,
            };
            try {
                await setDoc(configRef, configData);
                const feedback = document.getElementById('config-feedback');
                feedback.textContent = '設定已成功儲存！';
                setTimeout(() => feedback.textContent = '', 3000);
            } catch (e) {
                console.error("Error saving config:", e);
                // Cannot use alert
            }
        });

        document.getElementById('add-resident-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const householdInput = document.getElementById('resident-household');
            const nameInput = document.getElementById('resident-name');
            const newResident = {
                householdId: householdInput.value.trim(),
                name: nameInput.value.trim(),
                isCheckedIn: false,
                checkInTime: null,
            };
            if (newResident.householdId && newResident.name) {
                try {
                    await addDoc(residentsColRef, newResident);
                    householdInput.value = '';
                    nameInput.value = '';
                    householdInput.focus();
                } catch(e) {
                    console.error("Error adding resident: ", e);
                }
            }
        });

        document.getElementById('resident-list').addEventListener('click', async (e) => {
            if (e.target.closest('.delete-resident-btn')) {
                const btn = e.target.closest('.delete-resident-btn');
                const residentId = btn.dataset.id;
                const confirmed = await showConfirmModal('刪除住戶', '您確定要刪除這位住戶嗎？', '確定刪除');
                if (confirmed) {
                    try {
                        await deleteDoc(doc(db, `artifacts/${appId}/public/data/residents`, residentId));
                    } catch (e) {
                        console.error("Error deleting resident: ", e);
                    }
                }
            }
        });

        // --- Tabs Navigation ---
        const tabs = document.getElementById('tabs');
        const tabPanes = document.querySelectorAll('.tab-pane');
        tabs.addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON') {
                const tabId = e.target.dataset.tab;
                
                tabs.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
                e.target.classList.add('active');

                tabPanes.forEach(pane => {
                    if (pane.id === `${tabId}-tab`) {
                        pane.classList.remove('hidden');
                    } else {
                        pane.classList.add('hidden');
                    }
                });

                // Handle scanner logic on tab change
                if (tabId === 'scanner') {
                    startScanner();
                } else {
                    stopScanner();
                }
            }
        });

        // --- QR Code Scanner Logic ---
        function startScanner() {
            if (html5QrCode && html5QrCode.isScanning) {
                return;
            }
            html5QrCode = new Html5Qrcode("reader");
            const config = { fps: 10, qrbox: { width: 250, height: 250 } };
            
            document.getElementById('scanner-error').textContent = '正在啟動攝影機...';
            document.getElementById('stop-scanner-btn').classList.remove('hidden');

            html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess, onScanFailure)
                .then(() => {
                    document.getElementById('scanner-error').textContent = '';
                })
                .catch(err => {
                    document.getElementById('scanner-error').textContent = `無法啟動攝影機: ${err}`;
                    console.error("Camera start error:", err);
                });
        }
        
        function stopScanner() {
            if (html5QrCode && html5QrCode.isScanning) {
                html5QrCode.stop().then(() => {
                    console.log("Scanner stopped.");
                    document.getElementById('stop-scanner-btn').classList.add('hidden');
                }).catch(err => console.error("Scanner stop failed", err));
            }
        }
        
        document.getElementById('stop-scanner-btn').addEventListener('click', stopScanner);

        async function onScanSuccess(decodedText, decodedResult) {
            // Pause scanner to prevent multiple scans of the same code
            if (html5QrCode.isScanning) html5QrCode.pause();

            try {
                const residentRef = doc(db, `artifacts/${appId}/public/data/residents`, decodedText);
                const residentSnap = await getDoc(residentRef);

                if (residentSnap.exists()) {
                    const residentData = residentSnap.data();
                    if (residentData.isCheckedIn) {
                        showFeedback('重複報到', `${residentData.householdId} ${residentData.name} 已報到過。`, 'orange');
                        addScanLog(`${residentData.householdId} ${residentData.name}`, '重複報到', 'orange');
                    } else {
                        await updateDoc(residentRef, {
                            isCheckedIn: true,
                            checkInTime: serverTimestamp()
                        });
                        showFeedback('報到成功', `${residentData.householdId} ${residentData.name}`, 'green');
                        addScanLog(`${residentData.householdId} ${residentData.name}`, '報到成功', 'green');
                    }
                } else {
                    showFeedback('無效的 QR Code', '找不到對應的住戶資料。', 'red');
                    addScanLog(`無效的 Code: ${decodedText.substring(0, 8)}...`, '查無資料', 'red');
                }
            } catch (e) {
                console.error("Error processing scan:", e);
                showFeedback('處理錯誤', '發生網路或資料庫錯誤。', 'red');
            }

            // Resume scanner after a short delay
            setTimeout(() => {
                // Check if scanner exists and its state is paused
                if (html5QrCode && typeof html5QrCode.getState === 'function' && html5QrCode.getState() === 2) { // 2 corresponds to PAUSED state
                    html5QrCode.resume();
                }
            }, 2000);
        }


        function onScanFailure(error) {
            // This is called frequently, so we don't log every failure.
            // console.warn(`Code scan error = ${error}`);
        }
        
        function showFeedback(title, message, color) {
            const overlay = document.getElementById('feedback-overlay');
            const colorClasses = {
                green: 'bg-green-500',
                orange: 'bg-orange-500',
                red: 'bg-red-500'
            };
            const iconClasses = {
                green: 'fa-check-circle',
                orange: 'fa-exclamation-triangle',
                red: 'fa-times-circle'
            }

            const feedbackDiv = document.createElement('div');
            feedbackDiv.className = `feedback-animation text-white p-6 rounded-lg shadow-2xl text-center ${colorClasses[color]}`;
            feedbackDiv.innerHTML = `
                <i class="fas ${iconClasses[color]} text-5xl mb-3"></i>
                <h3 class="text-2xl font-bold">${title}</h3>
                <p class="text-lg">${message}</p>
            `;
            
            overlay.innerHTML = ''; // Clear previous
            overlay.appendChild(feedbackDiv);
            
            setTimeout(() => {
                if(overlay.contains(feedbackDiv)){
                   overlay.removeChild(feedbackDiv);
                }
            }, 2800);
        }
        
        function addScanLog(text, status, color) {
            const logContainer = document.getElementById('scan-log');
            const time = new Date().toLocaleTimeString('zh-TW', { hour12: false });
            const colorClasses = {
                green: 'border-green-500',
                orange: 'border-orange-500',
                red: 'border-red-500'
            };
            
            const logEntry = document.createElement('div');
            logEntry.className = `p-2 border-l-4 ${colorClasses[color]} bg-white rounded-r-lg shadow-sm`;
            logEntry.innerHTML = `
                <div class="flex justify-between items-center">
                    <span class="font-medium text-gray-800">${text}</span>
                    <span class="text-xs text-gray-500">${time}</span>
                </div>
                <p class="text-sm text-gray-600">${status}</p>
            `;
            logContainer.prepend(logEntry);
            // Keep log from growing too large
            if (logContainer.children.length > 50) {
                logContainer.removeChild(logContainer.lastChild);
            }
        }

        // --- QR Code Modal ---
        const qrModal = document.getElementById('qrcode-modal');
        document.getElementById('view-qrcodes-btn').addEventListener('click', () => qrModal.classList.remove('hidden'));
        document.getElementById('close-qrcode-modal-btn').addEventListener('click', () => qrModal.classList.add('hidden'));
        document.getElementById('print-qrcodes-btn').addEventListener('click', () => window.print());

    </script>
</body>
</html>
